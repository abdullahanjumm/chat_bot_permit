<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOD bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
        rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .navbar-custom {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1050;
            background-color: white;
            border-bottom: 1px solid #ccc;
        }

        #messageDisplay::before {
            content: "Chat Response:";
        }

        .sidebar {
            width: 300px;
            max-height: 100vh;
            overflow-y: auto;
            background-color: #f8f9fa;
            position: fixed;
            top: 56px;
            /* This aligns the sidebar below the navbar */
            left: 0;
            z-index: 1040;
        }

        .main-content {
            margin-left: 300px;
            /* Matches the width of the sidebar */
            padding-top: 70px;
            /* Adjust to account for the navbar height */
        }

        #phone-number {
            appearance: none;
            -moz-appearance: textfield;
            -webkit-appearance: none;
        }


        @media (max-width: 768px) {
            .sidebar {
                position: static;
                top: 0;
                width: 100%;
                z-index: 1040;
            }

            .main-content {
                margin-left: 0;
                padding-top: 60px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                top: 0;
                width: 100%;
                z-index: 1040;
            }

            .main-content {
                margin-left: 0;
                padding-top: 60px;
            }

            #typewriter {
                margin-top: 40vh !important;
            }
        }

        /* For screens larger than 768px */
        @media (min-width: 768px) {
            #typewriter {
                margin-top: 10vh !important;
                /* Adjust the value as needed */
            }
        }
    </style>
</head>

<body class="bg-white text-black">

    <div class="d-flex  ">
        <!-- Sidebar for Desktop -->

        <div class="d-none d-md-flex flex-column bg-light text-white p-3  max-vh-100"
            style="width: 250px;  overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; z-index: 1050;  position: fixed; top: 0; left: 0; height: 100vh;">
            <img src="assets/logo.png" alt="Logo" class="img-fluid mb-3" style="max-width: 80%; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;" />
            <h2 id="dashboard-title" class="text-center text-black"
                style="margin-top: 20px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease;">
                Dashboard
            </h2>
            <!-- Search Bar -->
            <input type="text" id="search-bar" class="form-control mb-3" placeholder="Search by Reference or Name"
                style="font-size: 14px;" />

            <ul class="nav flex-column" id="data-list" style="font-size: 12px;">
                <!-- Dynamic content will be inserted here -->
            </ul>
        </div>

        <!-- Toggle Button for Sidebar -->
        <button class="btn  d-md-none m-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar"
            aria-controls="offcanvasSidebar"
            style="width: 50px; height: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; z-index: 1050; position: relative; background-color: white;">
            <img src="assets/Vector.svg" alt="Icon" style="width: 25px; height: 25px;">
        </button>


        <!-- Offcanvas Sidebar -->
        <div class="offcanvas offcanvas-start bg-white text-dark" tabindex="-1" id="offcanvasSidebar"
            aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header">
                <!-- <h5 class="offcanvas-title" id="offcanvasSidebarLabel">MADINAH HEALTH CARE</h5> -->
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <!-- Sidebar Content -->
                <div class="text-center mb-4">
                    <h4 class="text-center text-black">MADINAH HEALTH CARE</h4>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a href="#" class="nav-link text-dark">Today</a>
                    </li>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12345 - Ali Khan
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12346 - Sara Ahmad
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12347 - Faisal Kareem
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                    </ul>
                    <li class="nav-item mb-2">
                        <a href="#" class="nav-link text-dark">Yesterday</a>
                    </li>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12345 - Ali Khan
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12346 - Sara Ahmad
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12347 - Faisal Kareem
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                    </ul>
                    <li class="nav-item mb-2">
                        <a href="#" class="nav-link text-dark">Previous 7 Days</a>
                    </li>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12345 - Ali Khan
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12346 - Sara Ahmad
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12347 - Faisal Kareem
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                    </ul>
                    <li class="nav-item">
                        <a href="#" class="nav-link text-dark">Previous 30 Days</a>
                    </li>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12345 - Ali Khan
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12346 - Sara Ahmad
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12347 - Faisal Kareem
                            <span class="badge bg-danger rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12346 - Sara Ahmad
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            REF12347 - Faisal Kareem
                            <span class="badge bg-success rounded-circle">&nbsp;</span>
                        </li>
                    </ul>
                </ul>
            </div>

        </div>

        <!-- Chat -->
        <div class="flex-grow-1 overflow-auto bg-white p-4 d-flex align-items-center justify-content-center flex-column min-vh-100"
            style="margin-left: 250px;">

            <!-- Header Section -->
            <header class="d-flex justify-content-end p-3"
                style="position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; align-items: center; background-color: transparent;">
                <!-- Notification Bell Icon -->
                <div class="notification-icon" style="position: relative; margin-right: 20px;">
                    <img src="assets/Shape.svg" alt="Profile" style="width: 30px; height: 30px; ">
                    <span class="badge"
                        style="position: absolute; top: -5px; right: -5px; background-color: red; color: white; font-size: 0.8rem; padding: 2px 5px; border-radius: 50%;">3</span>
                </div>
                <!-- Profile Icon -->
                <div class="profile-icon"
                    style="width: 30px; height: 30px; border-radius: 50%; background-color: #333333; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; font-weight: bold;">
                    A
                </div>
            </header>
            <div class="input-container d-flex flex-column align-items-center" style="max-width: 1200px; width: 100%; ">

                <h3 class="text-center mb-4" id="typewriter"> </h3>


                <!-- <div id="messageDisplay"
                    style="width: 100%; margin-bottom: 20px; max-height: 300px; overflow-y: auto; padding: 10px; background-color: #fff; border-radius: 10px;">

                </div>

                <div class="input-group" id="chatInputGroup"
                    style="position: relative; max-width: 50%; background-color: #f4f4f4; border-radius: 30px; padding: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <span class="input-group-text bg-transparent border-0">
                        <i class="bi bi-paperclip text-primary" style="font-size: 1.5rem;"></i>
                    </span>
                    <input type="text" class="form-control border-1" placeholder="Enter your message" id="chatInput"
                        style="background-color: #f4f4f4; border: none; outline: none; font-size: 1rem; padding: 10px 15px; width: 100%; border-radius: 30px;">
                    <div style="width: 100%; display: flex; justify-content: flex-end; margin-top: 10px;">
                        <button class="btn btn-primary rounded-circle d-flex justify-content-center align-items-center"
                            id="sendButton"
                            style="width: 50px; height: 50px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;">
                            <img src="assets/Vector.png" alt="Icon"
                                style="width: 24px; height: 24px; position: absolute;">
                            <i class="bi bi-arrow-right text-white" style="font-size: 1.5rem; position: absolute;"></i>
                        </button>
                    </div>
                </div> -->
                <div class="container my-5"
                    style="display: flex; flex-direction: column; padding: 10px; border: 1px solid #ddd; border-radius: 10px;">

                </div>

            </div>
            <div id="stickyText" style="
            position: fixed; 
            bottom: 25px; 
            right: 100px; 
            background-color: #892e1c; 
            color: #ffffff; 
            padding: 15px 20px; 
            border-radius: 30px; 
            font-family: Arial, sans-serif; 
            font-size: 16px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
            display: flex; 
            align-items: center; 
            gap: 10px;">
                <span>To add a new request, click here </span>
                <i class="bi bi-arrow-right-circle" style="font-size: 1.5rem;"></i>
            </div>

        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chatInput = document.getElementById("chatInput");
            const sendButton = document.getElementById("sendButton");
            const messageDisplay = document.getElementById("messageDisplay");
            const apiKey = 'gg'; // Replace with your OpenAI API key

            // Function to send message to ChatGPT API
            async function sendMessageToChatGPT(message) {
                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo", // or your desired model
                            messages: [{ role: "user", content: message }]
                        })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        return data.choices[0].message.content;
                    } else {
                        console.error("Error:", data);
                        return "Sorry, I couldn't process your request.";
                    }
                } catch (error) {
                    console.error("Error:", error);
                    return "An error occurred while connecting to the server.";
                }
            }

            // Function to append a message to the display
            function appendMessage(content, isUser = true) {
                const messageElement = document.createElement("div");
                messageElement.textContent = content;
                messageElement.style.padding = "10px";
                messageElement.style.marginBottom = "10px";
                messageElement.style.borderRadius = "10px";
                messageElement.style.color = isUser ? "#fff" : "#000";
                messageElement.style.backgroundColor = isUser ? "#007BFF" : "#F1F1F1";
                messageElement.style.alignSelf = isUser ? "flex-end" : "flex-start";
                messageDisplay.appendChild(messageElement);
                messageDisplay.scrollTop = messageDisplay.scrollHeight;
            }

            // Event Listener for Send Button
            sendButton.addEventListener("click", async function () {
                const userMessage = chatInput.value.trim();

                if (userMessage) {
                    appendMessage(userMessage, true); // Add user's message to the display
                    chatInput.value = "";

                    const chatGPTResponse = await sendMessageToChatGPT(userMessage); // Get response from ChatGPT
                    appendMessage(chatGPTResponse, false); // Add ChatGPT's response to the display
                }
            });

            // Optionally, send message on pressing Enter
            chatInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendButton.click();
                }
            });
        });

    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/script.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const text = "What can I help with?";
            const typewriterElement = document.getElementById("typewriter");
            let index = 0;
            function typeWriter() {
                if (index < text.length) {
                    typewriterElement.textContent += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, 100); // Typing speed in milliseconds
                }
            }

            typeWriter(); // Start the typewriter effect
        });

        document.addEventListener("DOMContentLoaded", function () {
            const inputField = document.getElementById("chatInput");
            const sendButton = document.getElementById("sendButton");
            const messageDisplay = document.getElementById("messageDisplay");
            const chatInputGroup = document.getElementById("chatInputGroup");

            // Function to update the position and width of the input group
            function updateInputPosition() {
                if (messageDisplay.childElementCount > 0) {
                    chatInputGroup.style.position = "absolute";
                    chatInputGroup.style.bottom = "20px";
                    chatInputGroup.style.left = "60%";
                    chatInputGroup.style.transform = "translateX(-50%)";
                    chatInputGroup.style.maxWidth = "50%"; // Set width to 50% when at the bottom
                } else {
                    chatInputGroup.style.position = "relative";
                    chatInputGroup.style.bottom = "unset";
                    chatInputGroup.style.left = "unset";
                    chatInputGroup.style.transform = "unset";
                    chatInputGroup.style.maxWidth = "100%"; // Reset width to full when not at the bottom
                }
            }

            // Handle message submission
            sendButton.addEventListener("click", function () {
                const userMessage = inputField.value.trim(); // Get the input value and trim spaces

                if (userMessage) {
                    // Create a new message element
                    const messageElement = document.createElement("p");
                    messageElement.textContent = userMessage;
                    messageElement.style.padding = "10px";
                    messageElement.style.borderRadius = "10px";
                    messageElement.style.backgroundColor = "#f8f9fa";
                    messageElement.style.color = "#000";
                    messageElement.style.marginBottom = "10px";

                    // Append the message to the display
                    messageDisplay.appendChild(messageElement);

                    // Update input position
                    updateInputPosition();

                    // Clear the input field
                    inputField.value = "";
                }
            });

            // Optionally handle the Enter key for message submission
            inputField.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendButton.click(); // Trigger button click on Enter key press
                }
            });

            // Monitor changes in the message display container
            const observer = new MutationObserver(updateInputPosition);
            observer.observe(messageDisplay, { childList: true });

            // Initial check to set the correct position
            updateInputPosition();
        });


        function closeSidebarOnResize() {
            const sidebar = document.getElementById("offcanvasSidebar");
            const bootstrapOffcanvas = bootstrap.Offcanvas.getInstance(sidebar);

            if (window.innerWidth > 768) {
                if (bootstrapOffcanvas && bootstrapOffcanvas._isShown) {
                    bootstrapOffcanvas.hide(); // Close the sidebar
                }
            }
        }
        window.addEventListener("resize", closeSidebarOnResize);



        //phone number did not input the negative value
        document.getElementById('phone-number').addEventListener('input', function (e) {
            if (this.value < 0) {
                this.value = 0; // Reset to 0 if a negative value is entered
            }
        });
    </script>

    <!-- api for sidebar all users -->
    <script>
        // Function to fetch data from the API
        async function fetchData() {
            try {
                const response = await fetch('https://medical-permits.vercel.app/getAllUsersData');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log('Fetched data:', data);
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }


        function cleanFileUrl(rawUrl) {
            // Use regex to extract the URL part only
            const urlMatch = rawUrl?.match(/https?:\/\/[^\s]+/);
            if (urlMatch) {
                return encodeURI(urlMatch[0]); // Encode the URL properly
            }
            return null;
        }

        // Function to display user details in the div
        function showUserDetails(user) {
            const container = document.querySelector('.container.my-5');

            if (!container) {
                console.error('Container element not found.');
                return;
            }

            // Hide the chat section when user details are shown
            // document.getElementById('messageDisplay').style.display = 'none';
            // document.getElementById('chatInputGroup').style.display = 'none';


            // Clean up the URLs
            const authorizationLetter = cleanFileUrl(user.authorization_letter);

            const medicalDoc = cleanFileUrl(user.medical_doc);
            // Initial container HTML
            let isEditable = false; // Track edit state
            // Bootstrap card for a modern layout
            container.innerHTML = `
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">Edit User Details</h3>
        </div>
        <div class="card-body">
            <form id="userDetailsForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="referenceNumber" class="form-label"><strong>Reference Number:</strong></label>
                            <input type="text" class="form-control" id="referenceNumber" name="referenceNumber" value="${user.reference_number}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label"><strong>Status:</strong></label>
                            <input type="text" class="form-control" id="status" name="status" value="${user.status}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="patientName" class="form-label"><strong>Patient Name:</strong></label>
                            <input type="text" class="form-control" id="patientName" name="patientName" value="${user.patient_name || 'N/A'}">
                        </div>
                        <div class="mb-3">
                            <label for="passportNo" class="form-label"><strong>ID Number:</strong></label>
                            <input type="text" class="form-control" id="passportNo" name="passportNo" value="${user.passport_no}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label"><strong>Phone Number:</strong></label>
                            <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" value="${user.phone_number || 'N/A'}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="primaryDoctor" class="form-label"><strong>Primary Doctor Name:</strong></label>
                            <input type="text" class="form-control" id="primaryDoctor" name="primaryDoctor" value="${user.primary_doctor || 'N/A'}">
                        </div>
                        <div class="mb-3">
                            <label for="emailAddress" class="form-label"><strong>E-mail Address:</strong></label>
                            <input type="email" class="form-control" id="emailAddress" name="emailAddress" value="${user.email_address || 'N/A'}">
                        </div>
                      
                        <div class="mb-3">
                            <label for="rejectReason" class="form-label"><strong>Reject Reason:</strong></label>
                            <textarea class="form-control" id="rejectReason" name="rejectReason" rows="3">${user.rejectReason || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label"><strong>Country:</strong></label>
                            <input type="text" class="form-control" id="country" name="country" value="${user.country || 'N/A'}">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="hospital" class="form-label"><strong>Hospital:</strong></label>
                            <input type="text" class="form-control" id="hospital" name="hospital" value="${user.hospital || 'N/A'}">
                        </div>
                        <div class="mb-3">
                            <label for="visaAssistant" class="form-label"><strong>Visa Assistant:</strong></label>
                            <input type="text" class="form-control" id="visaAssistant" name="visaAssistant" value="${user.visaAssistant || 'N/A'}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="createdAt" class="form-label"><strong>Created At:</strong></label>
                            <input type="text" class="form-control" id="createdAt" name="createdAt" value="${user.created_at}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="updatedAt" class="form-label"><strong>Updated At:</strong></label>
                            <input type="text" class="form-control" id="updatedAt" name="updatedAt" value="${user.updated_at}" readonly>
                        </div>
                    </div>
                </div>
                <hr>
                



                <div class="d-flex justify-content-between">
                    <div class="col-md-6 me-3">
                        <p><strong>Authorization Letter:</strong></p>
                        ${authorizationLetter
                          ? `<div class="file-preview" style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
                                 ${getFilePreview(authorizationLetter)}
                             </div>`
                          : '<span class="text-muted">Missing</span>'}
                        <a href="${authorizationLetter || '#'}" class="btn btn-outline-primary btn-sm w-100 mt-2" target="_blank" ${!authorizationLetter ? 'disabled' : ''}>Download Document</a>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2">Upload Document</button>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Medical Document:</strong></p>
                        ${medicalDoc
                          ? `<div class="file-preview" style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
                                 ${getFilePreview(medicalDoc)}
                             </div>`
                          : '<span class="text-muted">Missing</span>'}
                        <a href="${medicalDoc || '#'}" class="btn btn-outline-primary btn-sm w-100 mt-2" target="_blank" ${!medicalDoc ? 'disabled' : ''}>Download Document</a>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2">Upload Document</button>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary ms-2">Cancel</button>
                </div>

         
            </form>

                
        </div>
    </div>
`;

            // Add the event listeners after injecting the HTML
            const form = document.getElementById('userDetailsForm');

            if (form) {
                const saveButton = form.querySelector('button[type="submit"]');

                // Initially disable the Save button
                saveButton.disabled = true;

                // Add event listeners to all form inputs to detect changes
                form.addEventListener('input', () => {
                    saveButton.disabled = false;
                });

                form.addEventListener('change', () => {
                    saveButton.disabled = false;
                });
            }

            function getFilePreview(fileUrl) {
                // Extract file extension
                const fileExtension = fileUrl.split('.').pop().toLowerCase();

                // Check if the file is NOT a PDF
                if (fileExtension !== 'pdf') {
                    // Render non-PDF files in an iframe
                    return `<img src="${fileUrl}" alt="Image Preview" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    // For PDF files, just show the file type
                    return `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                            <img src="https://icon-library.com/images/doc-icon/doc-icon-4.jpg" alt="Image Preview" style="width: 80%; height: 80%; object-fit: contain;">
                        </div>`;

                }
            }

            document.getElementById('userDetailsForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(e.target);
                const updatedData = Object.fromEntries(formData.entries());

                // Transform the data to match API requirements
                const transformedData = {
                    patient_name: updatedData.patientName,
                    phone_number: updatedData.phoneNumber,
                    email_address: updatedData.emailAddress,
                    country: updatedData.country,
                    passport_no: updatedData.passportNo,
                    hospital: updatedData.hospital,

                    // medical_dokc: updatedData.medical_doc || null, // Handle medical document (if available)
                    // authorization_letter: updatedData.authorization_letter || null, // Handle authorization letter (if available)
                    visaAssistant: updatedData.visaAssistant,
                };

                console.log('Transformed Data:', transformedData);

                // API call
                try {
                    const response = await fetch(`https://medical-permits.vercel.app/updateData/${user.passport_no}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': 'Bearer YOUR_API_TOKEN', // Replace with your API token
                        },
                        body: JSON.stringify(transformedData),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('API Response:', result);
                        alert('Data updated successfully!');
                        window.location.reload();
                    } else {
                        console.error('API Error:', response.status, response.statusText);
                        alert('Failed to update data. Please try again.');
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Network Error:', error);
                    alert('An error occurred while updating the data.');
                }
            });



            // Create buttons for Approve, Reject, and Pending
            const approveButton = document.createElement('button');
            approveButton.className = 'btn btn-success btn-sm';
            approveButton.textContent = 'Approve';
            approveButton.addEventListener('click', (event) => {
                event.stopPropagation();
                approveUser(user);
            });

            const rejectButton = document.createElement('button');
            rejectButton.className = 'btn btn-danger btn-sm';
            rejectButton.textContent = 'Reject';
            rejectButton.addEventListener('click', (event) => {
                event.stopPropagation();
                rejectUser(user);
            });

            const pendingButton = document.createElement('button');
            pendingButton.className = 'btn btn-warning btn-sm';
            pendingButton.textContent = 'Pending';
            pendingButton.addEventListener('click', (event) => {
                event.stopPropagation();
                markAsPending(user);
            });

            // Create a div to hold the buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.marginTop = '20px'; // Add space above the buttons
            buttonContainer.appendChild(approveButton);
            buttonContainer.appendChild(rejectButton);
            buttonContainer.appendChild(pendingButton);

            // Append the button container below the details section
            container.appendChild(buttonContainer);
        }

        // Function to handle approve action
        async function approveUser(user) {
            try {
                const response = await fetch(`https://medical-permits.vercel.app/update/${user.passport_no}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'approved',  // Sending the status in the body
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    console.log('User approved:', data);
                    alert('User status updated to approved!');
                    location.reload();

                } else {
                    console.error('Error approving user:', data);
                }
            } catch (error) {
                console.error('Error during approveUser:', error);
            }
        }

        // Function to handle reject action
        async function rejectUser(user) {
            // Create and style the modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.zIndex = '2000';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '5px';
            modalContent.style.width = '400px';
            modalContent.style.textAlign = 'center';

            // Create the close button
            const closeModal = document.createElement('span');
            closeModal.textContent = '×';
            closeModal.style.position = 'absolute';
            closeModal.style.top = '10px';
            closeModal.style.right = '20px';
            closeModal.style.fontSize = '30px';
            closeModal.style.cursor = 'pointer';
            closeModal.style.color = 'white';
            modalContent.appendChild(closeModal);

            // Create the textarea for rejection reason
            const rejectionReasonInput = document.createElement('textarea');
            rejectionReasonInput.placeholder = 'Enter reason for rejection...';
            rejectionReasonInput.style.width = '100%';
            rejectionReasonInput.style.height = '100px';
            rejectionReasonInput.style.marginBottom = '20px';
            modalContent.appendChild(rejectionReasonInput);

            // Create the submit button
            const submitButton = document.createElement('button');
            submitButton.textContent = 'Submit Rejection';
            submitButton.style.backgroundColor = 'red';
            submitButton.style.color = 'white';
            submitButton.style.border = 'none';
            submitButton.style.padding = '10px 20px';
            submitButton.style.cursor = 'pointer';
            submitButton.style.borderRadius = '5px';
            modalContent.appendChild(submitButton);

            // Append the modal content to the modal
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close the modal when the close button is clicked
            closeModal.onclick = () => {
                document.body.removeChild(modal);
            };

            // Submit the rejection reason
            submitButton.onclick = async () => {
                const rejectionReason = rejectionReasonInput.value.trim();

                if (!rejectionReason) {
                    alert('Please provide a rejection reason.');
                    return;
                }

                try {
                    const response = await fetch(`https://medical-permits.vercel.app/update/${user.passport_no}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            status: 'rejected',  // Sending the status in the body
                            rejectReason: rejectionReason,  // Sending the rejection reason
                        }),
                    });

                    const data = await response.json();
                    if (response.ok) {
                        console.log('User rejected:', data);
                        alert('User status updated to rejected!');
                        location.reload();

                    } else {
                        console.error('Error rejecting user:', data);
                    }

                    // Close the modal after submission
                    document.body.removeChild(modal);
                } catch (error) {
                    console.error('Error during rejectUser:', error);
                    alert('An error occurred while rejecting the user.');
                }
            };
        }

        // Function to handle pending action
        async function markAsPending(user) {
            try {
                const response = await fetch(`https://medical-permits.vercel.app/update/${user.passport_no}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'pending',  // Sending the status in the body
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    console.log('User status set to pending:', data);
                    alert('User status updated to pending!');
                    location.reload();

                } else {
                    console.error('Error marking user as pending:', data);
                }
            } catch (error) {
                console.error('Error during markAsPending:', error);
            }
        }


        // Function to display the table when no user is selected
        function showTable(users) {
            const container = document.querySelector('.container.my-5');
            if (!container) {
                console.error('Container element not found.');
                return;
            }


            // Clear existing content in the container
            container.innerHTML = `
        <h3 style="font-size: 1.5rem; margin-bottom: 20px; color: #333;">Users List</h3>
        <table class="table table-striped table-bordered table-hover" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <thead style="background-color: #007438; color: white;">
                <tr>
                    <th style="padding: 12px; font-weight: bold;">Reference Number</th>
                    <th style="padding: 12px; font-weight: bold;">Patient Name</th>
                    <th style="padding: 12px; font-weight: bold;">Status</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(user => `
                    <tr>
                        <td style="padding: 12px; color: #333;">${user.reference_number}</td>
                        <td style="padding: 12px; color: #333;">${user.patient_name}</td>
                        <td style="padding: 12px; color: #333;">${user.status}</td>
                    </tr>`).join('')}
            </tbody>
        </table>
    `;
        }

        // Function to create a list item for each user
        function createListItem(user) {
            // Create the list item element
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.style.border = 'none';
            listItem.style.backgroundColor = 'transparent';
            listItem.style.marginBottom = '20px';
            listItem.style.color = 'black';
            listItem.style.cursor = 'pointer';  // Make the cursor a pointer

            // Add hover effect using inline styles for background change
            listItem.addEventListener('mouseenter', () => {
                listItem.style.backgroundColor = '#f0f0f0';  // Change background on hover
            });

            listItem.addEventListener('mouseleave', () => {
                listItem.style.backgroundColor = 'transparent';  // Reset the background color when the mouse leaves
            });

            // Create the span for user information
            const userInfo = document.createElement('span');
            userInfo.textContent = `${user.reference_number} - ${(user.patient_name && user.patient_name.trim()) ? user.patient_name : user.passport_no}`;


            // Create the badge element
            const badge = document.createElement('span');
            badge.className = `badge rounded-circle ${user.status === 'rejected' ? 'bg-danger' : user.status === 'pending' ? 'bg-warning' : 'bg-success'}`;
            badge.style.width = '10px';
            badge.style.height = '10px';
            badge.innerHTML = '&nbsp;'; // Add a non-breaking space to ensure the badge is visible

            // Append the userInfo and badge to the list item
            listItem.appendChild(userInfo);
            listItem.appendChild(badge);

            // Add click event listener to log the full user object
            listItem.addEventListener('click', () => {
                console.log('User object:', user);
                showUserDetails(user);
            });

            return listItem;
        }


        document.getElementById('dashboard-title').addEventListener('click', () => {
            const container = document.querySelector('.container.my-5');
            if (!container) {
                console.error('Container element not found.');
                return;
            }

            // Clear the content in the container to remove the selected user details
            container.innerHTML = '';

            // Show the chat section again
            // document.getElementById('messageDisplay').style.display = 'block';
            // document.getElementById('chatInputGroup').style.display = 'block';

            // Fetch and show the table again
            renderData();  // Ensure renderData fetches and displays the table
        });

        // Function to filter and display users based on the search query
        async function renderData() {
            const dataList = document.getElementById('data-list');
            if (!dataList) {
                console.error('Element with ID "data-list" not found.');
                return;
            }

            const users = await fetchData();
            console.log('Fetched users:', users);

            // Function to filter and render users based on the search query
            function filterAndRenderUsers(query = '') {
                // Filter users based on query
                const filteredUsers = users.filter(user =>
                    user.reference_number.toLowerCase().includes(query.toLowerCase()) ||
                    user.patient_name.toLowerCase().includes(query.toLowerCase())
                );

                // Clear existing content
                dataList.innerHTML = '';

                // Create and append list items for each filtered user
                filteredUsers.forEach(user => {
                    const listItem = createListItem(user);
                    dataList.appendChild(listItem);
                });

                // If no user is selected, show the table (optional logic)
                showTable(filteredUsers);
            }

            // Add event listener for search input
            document.getElementById('search-bar').addEventListener('input', (event) => {
                const query = event.target.value; // Get search input value
                filterAndRenderUsers(query); // Call the function to filter and render users
            });

            // Initially render all users when the page loads
            filterAndRenderUsers('');
        }



        // Call the renderData function when the page loads
        document.addEventListener('DOMContentLoaded', renderData);
    </script>
    <script src="https://cdn.botpress.cloud/webchat/v2.2/inject.js"></script>
    <script src="https://files.bpcontent.cloud/2025/01/03/10/20250103101601-7Y7YW069.js"></script>

    <!-- api for sidebar all users -->

</body>

</html>